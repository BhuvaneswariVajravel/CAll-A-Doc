#!/bin/bash
set -e
echo "Build iOS"
if [ "$#" -eq 2 ]; then
    appDir=$1
    packageId=$appDir
    outFile=$2
else
    if [ "$#" -eq 3 ]; then
        appDir=$1
        packageId=$2
        outFile=$3
    else
        echo "Illegal number of parameters"
    fi
fi
echo "TestApp Folder: $appDir" 
echo "PackageId: $packageId" 
echo "Output File: $outFile" 
node_modules/.bin/tns build ios --release --path $appDir
tar -czf $packageId.tgz --directory=$appDir/platforms/ios/build/emulator $packageId.app
mv $packageId.tgz out/$outFile.tgz

set +e
xcodebuild -version | grep '8.' &> /dev/null
if [ $? == 0 ]; then
    echo "Xcode 8 detected"
    echo "DevTeam: $DEVELOPMENT_TEAM" 
    if [ -f $appDir/app/App_Resources/iOS/build.xcconfig ]; then
        echo "Update build.xcconfig"
        sed -i bak -e "s|YOUR_TEAM_ID|${DEVELOPMENT_TEAM}|g" $appDir/app/App_Resources/iOS/build.xcconfig
        sed -i bak -e "s|// DEVELOPMENT_TEAM|DEVELOPMENT_TEAM|g" $appDir/app/App_Resources/iOS/build.xcconfig
        echo "build.xcconfig now looks like this:"
        cat $appDir/app/App_Resources/iOS/build.xcconfig
        if [ grep -q $DEVELOPMENT_TEAM $appDir/app/App_Resources/iOS/build.xcconfig ]; then 
            echo "TeamId found in $appDir/app/App_Resources/iOS/build.xcconfig."
            set -e
            node_modules/.bin/tns build ios --release --forDevice --path $appDir
        else
            echo "TeamId still not found in $appDir/app/App_Resources/iOS/build.xcconfig. Will build with --teamId"
            set -e
            node_modules/.bin/tns build ios --release --forDevice --path $appDir --teamId $DEVELOPMENT_TEAM
        fi
    else
        echo "build.xcconfig does NOT exist. Will build with --teamId"
        set -e
        node_modules/.bin/tns build ios --release --forDevice --path $appDir --teamId $DEVELOPMENT_TEAM
    fi
else
    echo "Xcode 7 detected, no need to update build.xcconfig"
    set -e
    node_modules/.bin/tns build ios --release --forDevice --path $appDir
fi
mv $appDir/platforms/ios/build/device/$packageId.ipa out/$outFile.ipa
