const path = require('path');
const dir = process.cwd();
const fs = require('fs');
const resolveAbsolutePath = require('./get-absolute-path.js').resolveAbsolutePath;

var pathToPackageJson = dir + '/package.json';

if (process.argv.indexOf("--path") != -1) {
    pathToPackageJson = resolveAbsolutePath((process.argv[process.argv.indexOf("--path") + 1] + '/package.json'));
}

var package = require(pathToPackageJson);

function updatePlatform(platoformType) {
    if (process.argv.indexOf(platoformType) != -1) {
        if (package.nativescript[platoformType] !== undefined) {
            package.nativescript[platoformType]['version'] = process.argv[process.argv.indexOf(platoformType) + 1];
        } else {
            package.nativescript[platoformType] = {};
            package.nativescript[platoformType].version = process.argv[process.argv.indexOf(platoformType) + 1];
        }
    }
}

function updateDependency(dependencies) {
    for (var index = 2; index < process.argv.length; index++) {
        const element = process.argv[index].replace("--", "");
        if (package[dependencies][element] !== undefined) {
            index += 1;
            let dep = process.argv[index];
            if (dep.indexOf("gz") > 0) {
                dep = "file://" + resolveAbsolutePath(dep);

                if (!fs.exists(dep)) {
                    console.log("Path to dependency is not correct!!!");
                }

                console.log("DEP:   " + dep);
            }

            package[dependencies][element] = dep;
        }
    }
}

updatePlatform("tns-android");
updatePlatform("tns-ios");
updateDependency("dependencies");
updateDependency("devDependencies");

fs.writeFile(pathToPackageJson, JSON.stringify(package, null, 2));
package = require(pathToPackageJson);
console.log("Updated package.json \n", package);